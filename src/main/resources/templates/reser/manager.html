<!DOCTYPE html>
<html lang="ja"
      xmlns:th="http://www.thymeleaf.org">
<head>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <title>トップページ</title>
  <style>
    .table-row-link {
      text-decoration: none;
      color: inherit;
      display: block;
    }
    .table td, .table th {
      text-align: center; /* 텍스트를 가운데 정렬 */
      vertical-align: middle; /* 세로 정렬 */
    }
    .table td a {
      display: flex;
      justify-content: space-between;
      width: 100%;
      padding: 5px 0;
    }
    .table td a span {
      flex: 1;
      text-align: center;
    }
  </style>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<div th:replace="~{header.html}"></div>
<div class="container-fluid d-flex flex-column align-items-center">
  <table class="table table-striped table-hover text-center">
    <tr>
      <th>가게이름</th>
      <th>요청사항</th>
      <th>예약시간</th>
      <th>예악아이디</th>
      <th>상세보기</th>
    </tr>
    <tr th:if="${managedetail.size()} == 0">
      <td colspan="5" style="text-align: center;">예약 정보가 없습니다.</td>
    </tr>
    <tr th:if="${managedetail} != null" th:each="manager : ${managedetail}" th:object="${manager}" style="cursor: pointer;">
      <input type="hidden" name="shopNo" id="shopNo" th:value="*{shopNo.no}">
      <td>
        <span th:text="*{shopNo.name}"></span>
      </td>
      <td>
        <span th:text="*{reserdetail}"></span>
      </td>
      <td style="max-width: 30px;">
        <span th:text="*{formattedresertime}"></span>
      </td>
      <td>
        <span th:text="*{userId.id}"></span>
      </td>
      <td>
        <button type="button" style="padding:6px 12px;" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal"
                th:onclick="openModal([[*{shopNo.no}]],[[*{shopNo.name}]], [[*{reserdetail}]],
                [[*{formattedresertime}]],[[*{userId.id}]],[[*{status}]])">상세보기
        </button>
      </td>
    </tr>
  </table>
</div>
<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">예약 상세 정보</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>가게 이름:</strong> <span id="modalShopName"></span></p>
        <p><strong>요청 사항:</strong> <span id="modalReserDetail"></span></p>
        <p><strong>예약 시간:</strong> <span id="modalReserTime"></span></p>
        <p><strong>예약 ID:</strong> <span id="modalUserIdText"></span></p>
        <p><strong>예약 상태:</strong> <span id="modalStatus"></span></p>
      </div>
      <div class="modal-footer">
        <!-- 예약확정 -->
        <form method="POST" action="/reser/updateStatus" onsubmit="return confirm('해당 고객의 예약을 확정하십니까?');">
          <input type="hidden" name="userId" id="modalHiddenUserIdForConfirm">
          <input type="hidden" name="status" id="modalHiddenStatusForConfirm" value="2">
          <input type="hidden" name="shopNo" id="modalShopNoForConfirm" value="">
          <button type="submit" class="btn btn-success">예약확정</button>
        </form>
        <!-- 예약취소 -->
        <form method="POST" action="/reser/updateStatus" onsubmit="return confirm('해당 고객의 예약을 취소하십니까?');">
          <input type="hidden" name="userId" id="modalHiddenUserIdForCancel">
          <input type="hidden" name="status" id="modalHiddenStatusForCancel" value="3">
          <input type="hidden" name="shopNo"  id="modalShopNoForCancel" value="">
          <button type="submit" style="padding:6px 12px;" class="btn btn-danger">예약취소</button>
        </form>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
      </div>
    </div>
  </div>
</div>
</body>
</html>
<script>
  var myModal = document.getElementById('myModal')
  var myInput = document.getElementById('myInput')

  myModal.addEventListener('shown.bs.modal', function () {
    myInput.focus()
  })
  // 모달에 데이터를 채우는 함수
  function openModal(shopNo, shopName, reserDetail, reserTime, userId, status) {
    document.getElementById("modalShopName").textContent = shopName;
    document.getElementById("modalReserDetail").textContent = reserDetail;
    document.getElementById("modalReserTime").textContent = reserTime;
    document.getElementById("modalUserIdText").textContent = userId;

    // 예약 상태 매핑
    const statusMap = {
      1: '예약대기',
      2: '예약완료',
      3: '예약취소',
    };
    document.getElementById('modalStatus').innerText = statusMap[status] || '알 수 없음';

    // 폼에 hidden 값 설정
    document.getElementById("modalShopNoForConfirm").value = shopNo;
    document.getElementById("modalShopNoForCancel").value = shopNo;
    document.getElementById("modalHiddenUserIdForConfirm").value = userId;
    document.getElementById("modalHiddenUserIdForCancel").value = userId;

    // 예약 확정 / 예약 취소 버튼에 맞게 status 값 설정
    if (status === 2) {
      document.getElementById("modalHiddenStatusForConfirm").value = 2; // 예약 확정
      document.getElementById("modalHiddenStatusForCancel").value = 3; // 예약 취소
    } else {
      document.getElementById("modalHiddenStatusForConfirm").value = 3; // 예약 취소
      document.getElementById("modalHiddenStatusForCancel").value = 2; // 예약 확정
    }
  }
</script>
